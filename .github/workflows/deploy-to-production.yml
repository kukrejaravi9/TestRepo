name: Schema update

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize, closed]
    
jobs:
  generate_delta_script:
    strategy:
      matrix:
        environment: ['dev', 'qa', 'prod']  
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        
      - name: Generate delta script
        run: |
          echo "${{ vars.DB_SERVER }}"
          echo "Hello World" >schema-changes.sql

      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v4.6.0
        with:
          name: delta-script
          path: schema-changes.sql       

  publish_stg:    
      if: github.event.pull_request.merged == true
      uses: kukrejaravi9/TestRepo/.github/workflows/reusable-deploy-to-server.yml@main
      with:
        environment: approval-dev
  
  publish_dev:
    needs: publish_stg
    if: github.event.pull_request.merged == true && always()
    uses: kukrejaravi9/TestRepo/.github/workflows/reusable-deploy-to-server.yml@main
    with:
      environment: approval-dev      

  publish_qa:
    needs: publish_dev
    if: github.event.pull_request.merged == true && always()
    uses: kukrejaravi9/TestRepo/.github/workflows/reusable-deploy-to-server.yml@main
    with:
      environment: approval-dev

  publish_prd:
    needs: publish_qa
    if: github.event.pull_request.merged == true && always()
    uses: kukrejaravi9/TestRepo/.github/workflows/reusable-deploy-to-server.yml@main
    with:
      environment: approval-dev
